:ruby
  # Required locals:
  #   board <Board>
  # board_tiles matrix: [[column, row] => BoardTile]
  bto_matrix = board.board_tiles_map
:css
  .board-tile-cell {
    width: 50px;
    height: 50px;
    text-align: center;
    vertical-align: middle;
    border: 2px solid lightgray;
    margin-left: 2px;
  }
  .board-tile-cell:hover {
    border: solid 3px #3366cc;
  }
  .board-tile-checkbox {
    width: 30px;
    height: 30px;
  }
:javascript
  /* The rotation of the tile for which user: none, user 1, user 2, then back to none 
  */
  function toggleTileUser() {
    let v = $(this).val();
    let currentSelectedUserNumber = $('input[name="current_user_number"]:checked').val();
    var nextV = currentSelectedUserNumber;
    if (typeof(nextV) == 'undefined' || nextV == '' || nextV == 'on') {
      nextV = '1';
    } else if (nextV && (typeof(nextV) == 'undefined' || nextV == '' || nextV == 'on') ) {
      nextV = '1';
    } else if (v == '1') {
      nextV = '2';
    } else if (v == '2') {
      nextV = '';
    }
    $(this).val(nextV);
    // console.log("| " + $(this).attr('id') + " | selected " + currentSelectedUserNumber + ", "+ v + " -> " + nextV);

    renderBoardTileCell(this);

    // Synch the radio button choice
    if (nextV == '') {
      $('input[name="current_user_number"][value]').prop('checked', false)
    } else {
      $('input[name="current_user_number"][value="' + nextV + '"]').prop('checked', true);
    }
  }


  /*
    @return <String> '1', '2' or ''
  */
  function renderBoardTileCell(checkBox){
    var v = $(checkBox).val();
    
    if (v == '1') {
      $(checkBox).parent().removeClass('user-2-bg-color').addClass('user-1-bg-color');
      $(checkBox).prop('checked', true);
    } else if (v == '2') {
      $(checkBox).parent().removeClass('user-1-bg-color').addClass('user-2-bg-color');
      $(checkBox).prop('checked', true);
    } else {
      $(checkBox).parent().removeClass('user-1-bg-color').removeClass('user-2-bg-color');
      $(checkBox).prop('checked', false);
    }
    return v;
  }

  function renderAllBoardTileCells() {
    const checkboxes = document.querySelectorAll('input.board-tile-checkbox');
    checkboxes.forEach(checkbox => {
      renderBoardTileCell( $(checkbox) );
    });
  }

  $( function() {
    renderAllBoardTileCells();

    const checkboxes = document.querySelectorAll('.board-tile-checkbox');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        toggleTileUser.call(this);
      });
    });
  });
-#%pre= bt_matrix.to_yaml
= form_for @board,  html:{ id:'board_form' } do |f|
  = hidden_field_tag :format, :js
  - if board.errors.any?
    #error_explanation
      %h2= "#{pluralize(board.errors.count, "error")} prohibited this board from being saved:"
      %ul
        - board.errors.full_messages.each do |message|
          %li= message
  .row
    .col-md-4.col-sm-6
      %div(class="form-group input-group mb-3")
        %span(class="input-group-text") 
          Columns
        = f.number_field :columns, class: 'form-control', placeholder: 'Columns', required: true, aria: { label: 'Columns', describedby: 'columns-addon1' }
        %span(class="input-group-text") 
          Rows
        = f.number_field :rows, class: 'form-control', placeholder: 'Rows', required: true, aria: { label: 'Rows', describedby: 'rows-addon1' }
  %div(class="form-group input-group mb-3")
    %label(for="current_user_number" class="input-group-text") 
      Choose which user for the tiles
    %input(type="radio" class="btn-check" name="current_user_number" id="current_user_number_option_1" value="1" autocomplete="off")
    %label(for="current_user_number_option_1" class="btn user-1-bg-color") User 1

    %input(type="radio" class="btn-check" name="current_user_number" id="current_user_number_option_2" value="2" autocomplete="off")
    %label(for="current_user_number_option_2" class="btn user-2-bg-color") User 2
  %div(class="form-group input-group mb-3")
    %table.table-striped
      %tbody
        - 1.upto(board.rows) do |row|
          %tr
            - 1.upto(board.columns) do |col|
              - existing_user_number = bto_matrix[[col, row]]&.first&.claiming_user_number || ''
              %td.board-tile-cell
                = check_box_tag "board_tiles[board_tile_at_#{col}_#{row}]", existing_user_number, id: "board_tile_#{col}_#{row}", class:'board-tile-checkbox', data:{ 'bs-toggle' => 'tooltip', 'bs-title' => "Tile at #{col},#{row}" }
  .actions
    %button(type='submit' class='btn btn-primary' data-disabled-with='Saving...')
      %i.bi.bi-floppy-fill
      Save
  