<% # Be aware that if the form submission is not executing Javascript code here, 
  # the format tag may have to set 'data-turbo'="false" and have hidden field format='js'.
-%>
<% if @changed_tiles.present?
    row_numbers_changed = @changed_tiles.collect(&:row).uniq
    total_scores_for_all_rows = @game.total_scores_for_all_rows

    @changed_tiles.each do |tile|
-%>
  // console.log("Updating tile at position <%= tile.column %>,<%= tile.row %> w/ card " + $("#game_board_tile_<%= tile.id %>").length );
  <% if tile.enfeebled? && tile.current_card_id.nil? %>
    $("#game_board_tile_<%= tile.id %> .card[data-card-id]").fadeOut(1000, function() {
        $("#game_board_tile_<%= tile.id %>").replaceWith("<%= j render(partial: 'game_board_tiles/table_cell', locals: { game_board_tile: tile, game: @game }) %>");
        $("#game_board_tile_<%= tile.id %>").droppable(droppableOptions());
      } );
  <% else -%>
    $("#game_board_tile_<%= tile.id %>").replaceWith("<%= j render(partial: 'game_board_tiles/table_cell', locals: { game_board_tile: tile, game: @game }) %>");
    $("#game_board_tile_<%= tile.id %> .card-detail-link[data-image-url]").click(showDetailOfCardInCanvas );
    $("#game_board_tile_<%= tile.id %> .card[data-card-id]").on('mouseover', showDetailLinkOfCard );
    $("#game_board_tile_<%= tile.id %> .card[data-card-id]").on('mouseout', hideDetailLinkOfCard );
  <% end # tile's update -%>
  <% end # each tile -%>
  <% 
    row_numbers_changed.each do|row| 
      player_1_score = total_scores_for_all_rows.dig(row, :player_1) || 0
      player_2_score = total_scores_for_all_rows.dig(row, :player_2) || 0
  -%>
    $("#player_1_row_<%= row %>_total_score").html("<%= j row_player_score_label(@game, row, 1, player_1_score, player_2_score) %>");
    $("#player_2_row_<%= row %>_total_score").html("<%= j row_player_score_label(@game, row, 2, player_1_score, player_2_score) %>");
  <% end %>
<% end # if @changed_tiles -%>

$("#game_current_player_frame").html("<%= j render(partial: 'games/players_and_current_turn', locals: { game: @game }) %>");

<% if flash[:warning].present? -%>
  showBoardNotice("<%= raw flash[:warning] %>", 'warning');
<% end -%>